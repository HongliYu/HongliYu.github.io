---
layout: post
title: "MVVM ä¸è¿¸å‘æ¶æ„ä¸­çš„ Realm"
date: 2017-01-12 17:49:55 +0200
categories: jekyll update
---

Realmæ˜¯ä¸ºç§»åŠ¨ç«¯æ‰“é€ çš„æ•°æ®åº“ï¼Œé¢å‘å¯¹è±¡çš„æ•°æ®åº“ï¼Œé‡å†™äº†å­˜å‚¨å¼•æ“ï¼Œå‘Šåˆ«ROMï¼Œçº¯ç²¹åŸç”Ÿçš„å¯¹è±¡å­˜å‚¨ã€‚[ä»‹ç»](https://realm.io/cn/news/realm-object-centric-present-day-database-mobile-applications/) åˆ’ä¸‹é‡ç‚¹ï¼š1. æ•°æ®å±‚åº“å’Œ ORMs 2. Realm ä¸æ˜¯é‡å¤ç°åœ¨çš„æŠ€æœ¯

Realm ç§»åŠ¨æ•°æ®åº“çš„ä¸€ä¸ªæ ‡å¿—æ€§ç‰¹æ€§ï¼šä½ å¯ä»¥åœ¨ä¸»çº¿ç¨‹é‡Œé¢è¯»å†™ï¼ä½ ä¸ç”¨æ‹…å¿ƒè¿™ä¼šé˜»å¡ä½ çš„ UIã€‚ä½†æˆ‘åŸæ¥çš„ç»“æ„æ˜¯å¹¶å‘çš„ï¼Œæ•°æ®çš„å¢åˆ æ”¹æŸ¥éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œæ€ä¹ˆæ¥å…¥æ˜¯ä¸ªé—®é¢˜ã€‚__underscores__ï¼ˆä»¥è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªæœ€ä½³å®è·µï¼Œåªæ˜¯ä¸´æ—¶çš„å¤„ç†æ–¹å¼ï¼‰

é¦–å…ˆä»‹ç»ä¸‹å½“å‰çš„MVVMæ˜¯è¿™æ ·çš„ç»“æ„ï¼š

## Model
å…ˆæ˜¯ RawModel, è¿™æ˜¯ Server ä¼ è¾“ç»™æˆ‘çš„ JSON æ•°æ®çš„æ˜ å°„äº§ç”Ÿçš„ Modelï¼Œæœ€çº¯ç²¹ï¼Œæœ€åŸå§‹çš„æ•°æ®ï¼Œæ²¡æœ‰ä»»ä½•åŠ å·¥ï¼Œä½†æˆ‘ä¸ä¼šåœ¨æ•°æ®åº“ä¸­å»å­˜å‚¨è¿™ä¸ªModel

## ViewModel
å®ƒæ˜¯å’ŒViewçš„æ˜¾ç¤ºæ˜¯ç›´æ¥ç›¸å…³è”çš„ï¼Œviewæ˜¯å®¹å™¨ï¼Œæˆ‘ä»¬åˆå§‹åŒ–å®¹å™¨ä»¥åï¼Œå®¹å™¨æ€ä¹ˆå‘ˆç°ç»™ç”¨æˆ·ï¼Œå®Œå…¨ä¾èµ–äºæ³¨å…¥çš„ViewModelã€‚å…¸å‹çš„æ¯”å¦‚UITableViewçš„cellï¼Œåªé€šè¿‡ä¸€ä¸ªæ–¹æ³•bindDataæ–¹æ³•ç»‘å®šViewModelå®Œæˆæ¸²æŸ“ã€‚ViewModelä¸­åŒ…å«ä¸€ä¸ªRawModelçš„propertyï¼Œæ‰€ä»¥ä»–ä»¬ä¹‹é—´çš„å…³ç³»æ˜¯ç»„åˆå…³ç³»ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æ˜¯ç»§æ‰¿ï¼Œæ–¹ä¾¿çœå»è®¿é—®RawModelçš„å±æ€§çš„è·¯ç”±ä»£ç ï¼Œæ¯”å¦‚viewmodel.model.propertyéœ€è¦ç®€å†™æˆviewmodel.propertyï¼Œé‚£ä¹ˆéœ€è¦ViewModelå†…éƒ¨å†™ä¸€ä¸ªå±æ€§æ˜ å°„ï¼Œç±»ä¼¼äºRailsä¸­çš„è·¯ç”±æ“ä½œï¼Œç»„åˆè¿˜æ˜¯ç»§æ‰¿çœ‹å…·ä½“æ¨¡å—æƒ…å†µè€Œå®šï¼Œæ²¡æœ‰å®šå¼ã€‚ViewModelè¿˜åŒ…å«ï¼Œç”¨æˆ·å‰ç«¯æ“ä½œéœ€è¦æŒä¹…åŒ–çš„ä¸€äº›å±æ€§ï¼Œæ¯”å¦‚cellä¸­çš„buttonæŒ‰ä¸‹ä»¥åï¼ŒçŠ¶æ€æ”¹å˜ï¼Œåœ¨é‡å¯appä»¥åæ”¹å˜è¿˜æ˜¯æœ‰æ•ˆçš„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ”¹å˜éœ€è¦æŒä¹…åŒ–ï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©åœ¨dbä¸­å­˜å‚¨çš„æ˜¯ViewModelï¼Œ
åŒ…å«Serverçš„æ•°æ®å’ŒClientç”¨æˆ·çš„å®šåˆ¶æ•°æ®ï¼Œåœ¨Sqlite3ä¸­ä»¥ViewModelä¸ºåŸºç¡€åštableï¼Œæˆ–è€…åœ¨OOçš„æ•°æ®åº“ä¸­ï¼Œä»¥ViewModelä¸ºåŸºç¡€å»ºç«‹æŒä¹…åŒ–å¯¹è±¡ã€‚ç„¶åVCä¹‹é—´åˆ‡æ¢ï¼Œä¿®æ”¹ViewModelä¸­çš„å±æ€§ï¼Œä¼ ç»Ÿæ–¹æ³•æ˜¯KVOï¼Œviewå“åº”å¼æ›´æ–°ï¼ŒSwiftæ²¡æœ‰ç°æˆçš„KVOï¼Œéœ€è¦Objectç»§æ‰¿NSObjectï¼Œæ‰€ä»¥å»ºè®®èµ°ç³»ç»ŸAPIï¼Œè·å–é‚£ä¸ªcellï¼Œå¹¶é‡æ–°ç»‘å®šæ•°æ®

## Manager
MainManager æ˜¯ä¸ª Singletonï¼Œå…¶ä¸­åŒ…å«ç±»ä¼¼äº UITableView ä¸­çš„æ•°æ®æºï¼Œæ¯”å¦‚ä¸€ä¸ª Arrayã€‚MainManager ä¼šå®Œæˆæ•°æ®å’Œ view ç»‘å®šä¹‹å‰æœ€åå†…å­˜ä¸­çš„æ“ä½œï¼Œæ¯”å¦‚filterï¼ŒæŒ‰ç…§æ¡ä»¶è¿‡æ»¤æ•°æ®ï¼Œè¿˜æœ‰å„ç§ action ä»¥åä¼šå›æ‰ç»™å…¶ä»– VC çš„ blockï¼Œå½±å“ä¸‹ä¸€æ¬¡æ•°æ®è¯·æ±‚çš„ä¸´æ—¶å˜é‡ï¼Œä»¥å Model è¦æ˜¯æœ‰æ”¹åŠ¨ä¹Ÿå¿…é¡»æ˜¯è°ƒç”¨ Manager ä¸­çš„æ–¹æ³•ï¼Œè®°ä½æ˜¯æ•°æ®å±•ç°å‰çš„æœ€åå†…å­˜ä¸­çš„æ“ä½œã€‚å¦å¤–ï¼Œè¿›å…¥æˆ–è€…é€€å‡ºæŸä¸ªæ¨¡å—çš„æ•°æ®åˆå§‹åŒ–æ“ä½œã€‚MainManageræœ‰ä¸€ä¸ª property æ˜¯ DataManagerï¼Œä»–è´Ÿè´£æ‰€æœ‰çš„æ•°æ®å­˜å–ï¼Œä»¥åŠé€šè¿‡ä¸åŒæ¸ é“æ‹¿åˆ°æ•°æ®ä»¥åçš„ mergeï¼Œä¼šæœ‰è¿™äº› propertiesï¼šDBRootï¼ŒNetworkServiceï¼ŒFileManagerï¼ŒDispatchQueueï¼ŒåŒ…å«çš„æ„ä¹‰æ˜¯æ•°æ®çš„æ¥æºï¼Œdisk ä¸Šçš„dbæˆ–è€… file systemï¼Œè¿˜æ˜¯ networkï¼Œæœ‰è‡ªå·±çš„ GCD ç®¡ç†çš„å¹¶å‘é˜Ÿåˆ—ï¼Œåªè¦åœ¨ IDE çš„æ–­ç‚¹çœ‹åˆ°è¿™ä¸ªé˜Ÿåˆ—ï¼Œé‚£ä¹ˆå°±æ˜¯åœ¨è¿™ä¸ª DataManager çš„æ“ä½œã€‚å…¶å®å¯¹äºä¸Šå±‚ MainManager æ¥è¯´ï¼Œä»–åªæ˜¯è¯·æ±‚æ•°æ®ï¼Œå¹¶ä¸å…³å¿ƒæ¥æºï¼Œéœ€è¦åˆ¶å®šæ¥æºå¯ä»¥åœ¨ methd ä¸­å¢åŠ å‚æ•°ï¼Œæ¯”å¦‚ç¬¬ä¸€æ¬¡è¿›å…¥VCçš„æ—¶å€™æ•°æ®è¯·æ±‚çš„é¡ºåºæ˜¯dbï¼Œselect -> present data -> network request -> present data -> db insertï¼Œä½†æ˜¯å¦‚æœæ˜¯å½“å‰VCçš„ refresh æ“ä½œå°±ä¸éœ€è¦è¯·æ±‚æ•°æ®åº“å¯¹å§ï¼Œè¿™æ˜¯ä¸ä¸€æ ·çš„

## ViewController
æ¯æ¬¡è¿›å…¥VCä¼šåšè¿™ä¹ˆå‡ ä»¶äº‹æƒ…ï¼ŒbasicUIï¼ŒrequestBasicDataï¼ŒbindActionsï¼ŒregistNotificationsï¼Œé‡åˆ°ä¸šåŠ¡å¤æ‚çš„æ ¸å¿ƒVCï¼Œactionsä¼šç‰¹åˆ«å¤šï¼Œå»ºè®®åˆ†ç¦»åˆ°businessä¸šåŠ¡å±‚, æ‰€ä»¥åˆå¤šä¸€ä¸ªæ“ä½œå« bindBusinessï¼Œè®°å¾—ç»™ä¸€ä¸ª weak reference è§£å†³ retain cycleçš„é—®é¢˜

![integrate-realm-to-mvvm-swift-0]({{ "/assets/integrate-realm-to-mvvm-swift-0.png" | absolute_url }})

![integrate-realm-to-mvvm-swift-1]({{ "/assets/integrate-realm-to-mvvm-swift-1.png" | absolute_url }})

## DBRoot
Realm å¯¹è±¡åªèƒ½é€šè¿‡ä»æœ€åˆåˆ›å»ºçš„ä»–çš„é‚£ä¸ªçº¿ç¨‹è®¿é—®ï¼Œå¢åˆ æ”¹æŸ¥çš„æ‰€æœ‰æ“ä½œéƒ½å¿…é¡»åœ¨è¿™ä¸ªçº¿ç¨‹ä¸Šï¼Œå› ä¸ºæœ¬æ¥è®¾è®¡æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸Šï¼Œè€Œæˆ‘çš„æ¡†æ¶æ˜¯å¹¶å‘çš„ğŸ˜“ã€‚é‚£ä¹ˆï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿæ¶‰åŠåˆ°ä¸€ä¸ªå°çŸ¥è¯†ï¼Œå°±æ˜¯runloopï¼Œå­çº¿ç¨‹å­˜æ´»ï¼Œä¸€ä¸ª while true çš„å¾ªç¯ï¼Œç­‰å¾…å“åº”ï¼Œè™½ç„¶åœ¨ DataManager çš„å¹¶å‘çš„é˜Ÿåˆ—ä¸Šï¼Œä½†æ˜¯ realm çš„çº¿ç¨‹åªæœ‰ä¸€ä¸ªï¼Œç›´åˆ°é€€å‡ºæ¨¡å—ï¼Œé”€æ¯æ‰€æœ‰å†…å®¹ã€‚ç„¶åé‚£ä¸ª NSCondition å¯¹è±¡ä¼šä¿è¯ï¼Œæ·»åŠ åˆ° task pool ä¸­çš„ block é¡ºåºè¿›è¡Œä¸ä¼šæœ‰è„æ•°æ®äº§ç”Ÿã€‚è¿˜æœ‰è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œrealm å¯¹è±¡å¾—åˆ°çš„ collection æ˜¯å¼•ç”¨æ˜¯ lazy initï¼Œæ‰€ä»¥å¯¹ collection çš„ç›´æ¥æ“ä½œå¿…é¡»è¿˜æ˜¯åœ¨ realm çº¿ç¨‹ä¸Šçš„ï¼Œå°½ç®¡å¯èƒ½å·²ç»æŠ›å‡º result åˆ° DataManager è¿™ä¸€å±‚ï¼Œæ³¨æ„å½“å‰ä»£ç æ‰€åœ¨çš„é˜Ÿåˆ—å’Œçº¿ç¨‹ï¼Œå¥½åœ¨å¦‚æœæ“ä½œä¸åœ¨ realm çº¿ç¨‹ä¸Šï¼Œassertä¸€ä¸ªæ–­è¨€ç«‹åˆ»crashï¼ŒåŠæ—¶ä¿®å¤é”™è¯¯ã€‚
é“ç†éƒ½æ‡‚ï¼Œçœ‹DBRoot.swiftçš„ä»£ç : [DBRoot](https://gist.github.com/anonymous/0e5e60bffc677044ab84a1994be0e90d)
